// API Base URL
const API_BASE = 'http://localhost:3000/api';

// State Management
let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
let courses = [];
let enrolledCourses = [];
let assignments = [];

// Initialize App
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
    setupEventListeners();
    loadCourses();
    if (currentUser) {
        updateUIForUser();
        if (currentUser.role === 'student') {
            loadStudentData();
        } else if (currentUser.role === 'admin') {
            loadAdminData();
        }
    }
});

// Initialize App
function initializeApp() {
    showPage('homePage');
}

// Setup Event Listeners
function setupEventListeners() {
    // Navigation
    document.getElementById('homeLink').addEventListener('click', () => showPage('homePage'));
    document.getElementById('coursesLink').addEventListener('click', () => {
        showPage('coursesPage');
        loadCourses();
    });
    document.getElementById('dashboardLink').addEventListener('click', () => {
        if (currentUser?.role === 'student') {
            showPage('studentDashboard');
            loadStudentData();
        }
    });
    document.getElementById('adminLink').addEventListener('click', () => {
        if (currentUser?.role === 'admin') {
            showPage('adminDashboard');
            loadAdminData();
        }
    });
    document.getElementById('loginLink').addEventListener('click', () => openAuthModal());
    document.getElementById('logoutLink').addEventListener('click', logout);
    document.getElementById('exploreBtn').addEventListener('click', () => {
        showPage('coursesPage');
        loadCourses();
    });

    // Auth Modal
    document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
    document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);

    // Close modals
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal) closeModal(modal.id);
        });
    });

    // Course Management
    document.getElementById('addCourseBtn')?.addEventListener('click', () => openCourseModal());
    document.getElementById('courseForm')?.addEventListener('submit', handleCourseSubmit);

    // Search and Filter
    document.getElementById('searchInput')?.addEventListener('input', filterCourses);
    document.getElementById('categoryFilter')?.addEventListener('change', filterCourses);

    // Assignment Form
    document.getElementById('assignmentForm')?.addEventListener('submit', handleAssignmentSubmit);
}

// Page Navigation
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(pageId)?.classList.add('active');
}

// Modal Functions
function openModal(modalId) {
    document.getElementById(modalId)?.classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId)?.classList.remove('active');
    if (modalId === 'courseModal') {
        document.getElementById('courseForm').reset();
        document.getElementById('courseId').value = '';
    }
    if (modalId === 'assignmentModal') {
        document.getElementById('assignmentForm').reset();
    }
}

function openAuthModal() {
    openModal('authModal');
    switchAuthTab('login');
}

function switchAuthTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
    
    if (tab === 'login') {
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('loginForm').classList.add('active');
    } else {
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('registerForm').classList.add('active');
    }
}

// Authentication
async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const role = document.getElementById('loginRole').value;

    try {
        const response = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, role })
        });

        const data = await response.json();
        
        if (response.ok) {
            currentUser = data.user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUIForUser();
            closeModal('authModal');
            showSuccessMessage('Login successful!');
            
            if (currentUser.role === 'student') {
                showPage('studentDashboard');
                loadStudentData();
            } else {
                showPage('adminDashboard');
                loadAdminData();
            }
        } else {
            showErrorMessage(data.message || 'Login failed');
        }
    } catch (error) {
        showErrorMessage('Network error. Please check if the server is running.');
        console.error('Login error:', error);
    }
}

async function handleRegister(e) {
    e.preventDefault();
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const role = document.getElementById('registerRole').value;

    try {
        const response = await fetch(`${API_BASE}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password, role })
        });

        const data = await response.json();
        
        if (response.ok) {
            showSuccessMessage('Registration successful! Please login.');
            switchAuthTab('login');
        } else {
            showErrorMessage(data.message || 'Registration failed');
        }
    } catch (error) {
        showErrorMessage('Network error. Please check if the server is running.');
        console.error('Register error:', error);
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    updateUIForUser();
    showPage('homePage');
    showSuccessMessage('Logged out successfully');
}

function updateUIForUser() {
    const isLoggedIn = !!currentUser;
    document.getElementById('loginLink').style.display = isLoggedIn ? 'none' : 'block';
    document.getElementById('logoutLink').style.display = isLoggedIn ? 'block' : 'none';
    document.getElementById('dashboardLink').style.display = (isLoggedIn && currentUser.role === 'student') ? 'block' : 'none';
    document.getElementById('adminLink').style.display = (isLoggedIn && currentUser.role === 'admin') ? 'block' : 'none';
}

// Courses
async function loadCourses() {
    try {
        const response = await fetch(`${API_BASE}/courses`);
        const data = await response.json();
        courses = data.courses || [];
        displayCourses(courses);
    } catch (error) {
        console.error('Error loading courses:', error);
        // Fallback to local data if API fails
        courses = getLocalCourses();
        displayCourses(courses);
    }
}

function displayCourses(coursesToDisplay) {
    const grid = document.getElementById('coursesGrid');
    if (!grid) return;

    grid.innerHTML = coursesToDisplay.map(course => `
        <div class="course-card" data-course-id="${course.id}">
            <h3>${course.title}</h3>
            <span class="category">${course.category}</span>
            <p class="description">${course.description}</p>
            <div class="meta">
                <span>⏱ ${course.duration} hours</span>
                ${currentUser?.role === 'student' ? 
                    `<button class="btn btn-primary" onclick="enrollInCourse(${course.id})">Enroll</button>` :
                    ''
                }
            </div>
        </div>
    `).join('');

    // Add click listeners for course details
    document.querySelectorAll('.course-card').forEach(card => {
        card.addEventListener('click', (e) => {
            if (!e.target.classList.contains('btn')) {
                const courseId = parseInt(card.dataset.courseId);
                showCourseDetails(courseId);
            }
        });
    });
}

async function enrollInCourse(courseId) {
    if (!currentUser || currentUser.role !== 'student') {
        showErrorMessage('Please login as a student to enroll');
        return;
    }

    try {
        const response = await fetch(`${API_BASE}/courses/${courseId}/enroll`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.id}`
            }
        });

        const data = await response.json();
        
        if (response.ok) {
            showSuccessMessage('Successfully enrolled in course!');
            loadStudentData();
        } else {
            showErrorMessage(data.message || 'Enrollment failed');
        }
    } catch (error) {
        console.error('Enrollment error:', error);
        // Fallback: add to local enrolled courses
        if (!enrolledCourses.find(c => c.id === courseId)) {
            const course = courses.find(c => c.id === courseId);
            if (course) {
                enrolledCourses.push(course);
                showSuccessMessage('Successfully enrolled in course!');
                loadStudentData();
            }
        }
    }
}

function filterCourses() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;

    const filtered = courses.filter(course => {
        const matchesSearch = course.title.toLowerCase().includes(searchTerm) ||
                            course.description.toLowerCase().includes(searchTerm);
        const matchesCategory = !category || course.category === category;
        return matchesSearch && matchesCategory;
    });

    displayCourses(filtered);
}

function showCourseDetails(courseId) {
    const course = courses.find(c => c.id === courseId);
    if (!course) return;

    const content = document.getElementById('courseDetailContent');
    content.innerHTML = `
        <h2>${course.title}</h2>
        <span class="category">${course.category}</span>
        <p class="description" style="margin: 1rem 0;">${course.description}</p>
        <div class="meta">
            <span>⏱ Duration: ${course.duration} hours</span>
        </div>
        ${currentUser?.role === 'student' ? 
            `<div class="course-actions">
                <button class="btn btn-primary" onclick="enrollInCourse(${course.id}); closeModal('courseDetailModal');">Enroll Now</button>
            </div>` :
            ''
        }
    `;
    openModal('courseDetailModal');
}

// Student Dashboard
async function loadStudentData() {
    if (!currentUser || currentUser.role !== 'student') return;

    try {
        // Load enrolled courses
        const enrollResponse = await fetch(`${API_BASE}/students/${currentUser.id}/courses`, {
            headers: { 'Authorization': `Bearer ${currentUser.id}` }
        });
        const enrollData = await enrollResponse.json();
        enrolledCourses = enrollData.courses || [];

        // Load assignments
        const assignResponse = await fetch(`${API_BASE}/students/${currentUser.id}/assignments`, {
            headers: { 'Authorization': `Bearer ${currentUser.id}` }
        });
        const assignData = await assignResponse.json();
        assignments = assignData.assignments || [];

        displayEnrolledCourses();
        displayTasks();
        displayProgress();
    } catch (error) {
        console.error('Error loading student data:', error);
        // Use local data
        displayEnrolledCourses();
        displayTasks();
        displayProgress();
    }
}

function displayEnrolledCourses() {
    const container = document.getElementById('enrolledCourses');
    if (!container) return;

    if (enrolledCourses.length === 0) {
        container.innerHTML = '<p>You are not enrolled in any courses yet.</p>';
        return;
    }

    container.innerHTML = enrolledCourses.map(course => `
        <div class="course-card">
            <h3>${course.title}</h3>
            <span class="category">${course.category}</span>
            <p class="description">${course.description}</p>
            <div class="course-actions">
                <button class="btn btn-secondary" onclick="openAssignmentModal(${course.id})">Submit Assignment</button>
            </div>
        </div>
    `).join('');
}

function displayTasks() {
    const container = document.getElementById('myTasks');
    if (!container) return;

    if (assignments.length === 0) {
        container.innerHTML = '<p>No assignments yet.</p>';
        return;
    }

    container.innerHTML = assignments.map(assignment => `
        <div class="task-item">
            <h4>${assignment.title}</h4>
            <p>${assignment.courseTitle || 'Course Assignment'}</p>
            <div class="task-meta">
                <span>Status: <span class="task-status ${assignment.status}">${assignment.status}</span></span>
                <span>Submitted: ${new Date(assignment.submittedAt || Date.now()).toLocaleDateString()}</span>
            </div>
            ${assignment.status !== 'graded' ? 
                `<button class="btn btn-outline" onclick="openAssignmentModal(${assignment.courseId}, ${assignment.id})" style="margin-top: 0.5rem;">Update Submission</button>` :
                ''
            }
        </div>
    `).join('');
}

function displayProgress() {
    const container = document.getElementById('progressSection');
    if (!container) return;

    if (enrolledCourses.length === 0) {
        container.innerHTML = '<p>No progress to display.</p>';
        return;
    }

    container.innerHTML = enrolledCourses.map(course => {
        const courseAssignments = assignments.filter(a => a.courseId === course.id);
        const completed = courseAssignments.filter(a => a.status === 'graded').length;
        const total = courseAssignments.length || 1;
        const progress = Math.round((completed / total) * 100);

        return `
            <div class="progress-card">
                <h4>${course.title}</h4>
                <div>${completed} of ${total} assignments completed</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div style="margin-top: 0.5rem; font-weight: 600;">${progress}%</div>
            </div>
        `;
    }).join('');
}

function openAssignmentModal(courseId, assignmentId = null) {
    if (!currentUser || currentUser.role !== 'student') {
        showErrorMessage('Please login as a student');
        return;
    }

    document.getElementById('assignmentCourseId').value = courseId;
    document.getElementById('assignmentId').value = assignmentId || '';

    const course = enrolledCourses.find(c => c.id === courseId);
    const assignment = assignmentId ? assignments.find(a => a.id === assignmentId) : null;

    if (assignment) {
        document.getElementById('assignmentTitle').value = assignment.title;
        document.getElementById('assignmentContent').value = assignment.content || '';
        document.getElementById('submitAssignmentBtn').textContent = 'Update Submission';
        
        const statusDiv = document.getElementById('assignmentStatus');
        statusDiv.className = `status-info ${assignment.status === 'graded' ? 'info' : 'success'}`;
        statusDiv.textContent = `Current Status: ${assignment.status}`;
    } else {
        document.getElementById('assignmentForm').reset();
        document.getElementById('submitAssignmentBtn').textContent = 'Submit';
        document.getElementById('assignmentStatus').textContent = '';
    }

    openModal('assignmentModal');
}

async function handleAssignmentSubmit(e) {
    e.preventDefault();
    const courseId = parseInt(document.getElementById('assignmentCourseId').value);
    const assignmentId = document.getElementById('assignmentId').value;
    const title = document.getElementById('assignmentTitle').value;
    const content = document.getElementById('assignmentContent').value;

    try {
        const url = assignmentId ? 
            `${API_BASE}/assignments/${assignmentId}` : 
            `${API_BASE}/assignments`;
        
        const method = assignmentId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.id}`
            },
            body: JSON.stringify({
                courseId,
                title,
                content,
                studentId: currentUser.id
            })
        });

        const data = await response.json();
        
        if (response.ok) {
            showSuccessMessage(assignmentId ? 'Assignment updated successfully!' : 'Assignment submitted successfully!');
            closeModal('assignmentModal');
            loadStudentData();
        } else {
            showErrorMessage(data.message || 'Submission failed');
        }
    } catch (error) {
        console.error('Assignment error:', error);
        // Fallback: add to local assignments
        const newAssignment = {
            id: assignmentId || Date.now(),
            courseId,
            title,
            content,
            status: 'submitted',
            submittedAt: new Date().toISOString(),
            courseTitle: enrolledCourses.find(c => c.id === courseId)?.title
        };
        
        if (assignmentId) {
            const index = assignments.findIndex(a => a.id === parseInt(assignmentId));
            if (index !== -1) assignments[index] = { ...assignments[index], ...newAssignment };
        } else {
            assignments.push(newAssignment);
        }
        
        showSuccessMessage(assignmentId ? 'Assignment updated successfully!' : 'Assignment submitted successfully!');
        closeModal('assignmentModal');
        loadStudentData();
    }
}

// Admin Dashboard
async function loadAdminData() {
    if (!currentUser || currentUser.role !== 'admin') return;
    await loadCourses();
    displayAdminCourses();
}

function displayAdminCourses() {
    const container = document.getElementById('adminCourses');
    if (!container) return;

    container.innerHTML = courses.map(course => `
        <div class="course-card">
            <h3>${course.title}</h3>
            <span class="category">${course.category}</span>
            <p class="description">${course.description}</p>
            <div class="meta">
                <span>⏱ ${course.duration} hours</span>
            </div>
            <div class="course-actions">
                <button class="btn btn-primary" onclick="editCourse(${course.id})">Edit</button>
                <button class="btn btn-danger" onclick="deleteCourse(${course.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

function openCourseModal(courseId = null) {
    const course = courseId ? courses.find(c => c.id === courseId) : null;
    
    document.getElementById('courseModalTitle').textContent = course ? 'Edit Course' : 'Add New Course';
    document.getElementById('courseId').value = courseId || '';
    
    if (course) {
        document.getElementById('courseTitle').value = course.title;
        document.getElementById('courseDescription').value = course.description;
        document.getElementById('courseCategory').value = course.category;
        document.getElementById('courseDuration').value = course.duration;
    } else {
        document.getElementById('courseForm').reset();
    }
    
    openModal('courseModal');
}

function editCourse(courseId) {
    openCourseModal(courseId);
}

async function handleCourseSubmit(e) {
    e.preventDefault();
    const courseId = document.getElementById('courseId').value;
    const courseData = {
        title: document.getElementById('courseTitle').value,
        description: document.getElementById('courseDescription').value,
        category: document.getElementById('courseCategory').value,
        duration: parseInt(document.getElementById('courseDuration').value)
    };

    try {
        const url = courseId ? `${API_BASE}/courses/${courseId}` : `${API_BASE}/courses`;
        const method = courseId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentUser.id}`
            },
            body: JSON.stringify(courseData)
        });

        const data = await response.json();
        
        if (response.ok) {
            showSuccessMessage(courseId ? 'Course updated successfully!' : 'Course created successfully!');
            closeModal('courseModal');
            await loadCourses();
            displayAdminCourses();
        } else {
            showErrorMessage(data.message || 'Operation failed');
        }
    } catch (error) {
        console.error('Course error:', error);
        // Fallback: update local courses
        if (courseId) {
            const index = courses.findIndex(c => c.id === parseInt(courseId));
            if (index !== -1) {
                courses[index] = { ...courses[index], ...courseData };
            }
        } else {
            const newCourse = {
                id: Date.now(),
                ...courseData,
                createdAt: new Date().toISOString()
            };
            courses.push(newCourse);
        }
        
        showSuccessMessage(courseId ? 'Course updated successfully!' : 'Course created successfully!');
        closeModal('courseModal');
        loadCourses();
        displayAdminCourses();
    }
}

async function deleteCourse(courseId) {
    if (!confirm('Are you sure you want to delete this course?')) return;

    try {
        const response = await fetch(`${API_BASE}/courses/${courseId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${currentUser.id}` }
        });

        if (response.ok) {
            showSuccessMessage('Course deleted successfully!');
            await loadCourses();
            displayAdminCourses();
        } else {
            const data = await response.json();
            showErrorMessage(data.message || 'Delete failed');
        }
    } catch (error) {
        console.error('Delete error:', error);
        // Fallback: remove from local courses
        courses = courses.filter(c => c.id !== courseId);
        showSuccessMessage('Course deleted successfully!');
        loadCourses();
        displayAdminCourses();
    }
}

// Utility Functions
function showSuccessMessage(message) {
    showMessage(message, 'success');
}

function showErrorMessage(message) {
    showMessage(message, 'error');
}

function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `status-info ${type}`;
    messageDiv.textContent = message;
    messageDiv.style.position = 'fixed';
    messageDiv.style.top = '100px';
    messageDiv.style.right = '20px';
    messageDiv.style.zIndex = '3000';
    messageDiv.style.minWidth = '300px';
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Local Data Fallback
function getLocalCourses() {
    return [
        {
            id: 1,
            title: 'Introduction to Web Development',
            description: 'Learn the fundamentals of HTML, CSS, and JavaScript to build modern web applications.',
            category: 'programming',
            duration: 40
        },
        {
            id: 2,
            title: 'UI/UX Design Principles',
            description: 'Master the art of creating beautiful and user-friendly interfaces.',
            category: 'design',
            duration: 30
        },
        {
            id: 3,
            title: 'Business Management Fundamentals',
            description: 'Essential skills for managing teams and projects effectively.',
            category: 'business',
            duration: 35
        },
        {
            id: 4,
            title: 'English for Professionals',
            description: 'Improve your English communication skills for the workplace.',
            category: 'language',
            duration: 50
        }
    ];
}

